{% extends 'base.html' %}
{% load static %}

{% block title %}PCR Datenbank - Inventory{% endblock %}

{% block content %}

<style>
  /* Updated filter section styling */
  .filter-header {
    background-color: #34495e !important; /* Darker slate blue */
    color: white;
  }

  /* Slider customizations */
  .ui-slider {
    height: 6px;
    background: #e9ecef;
    border: none;
    margin: 5px 0;
  }

  .ui-slider .ui-slider-range {
    background: #3498db; /* Softer blue for slider range */
  }

  .ui-slider .ui-slider-handle {
    border-radius: 50%;
    width: 14px;
    height: 14px;
    top: -4px;
    border: 2px solid #3498db;
    background: white;
  }

  /* Action button styling */
  .filter-apply-btn {
    background-color: #3498db !important;
    color: white !important;
    border: none !important;
  }

  .filter-apply-btn:hover {
    background-color: #2980b9 !important;
  }

   tr.selected {
      outline: 2px solid rgba(52, 152, 219, 0.3) !important;
      position: relative;
   }

   .form-check-input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
   }

     /* Custom row background colors with controlled intensities */
    .in-use-by-others {
        background-color: rgba(220, 53, 69, 0.15) !important; /* Red for in-use, slightly reduced */
    }
    .reserved-by-me {
        background-color: rgba(255, 193, 7, 0.15) !important; /* Yellow for my reservations */
    }
    .reserved-by-others {
        background-color: rgba(253, 126, 20, 0.08) !important; /* Very subtle peach for others' reservations */
    }
</style>

<div class="container-fluid mt-4">
    <!-- Search and Actions Row -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="search-container" style="width: 50%;">
                            <form method="GET" action="{% url 'core:inventory' %}">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search inventory..." name="search" value="{{ search_term|default:'' }}">
                                    <button class="btn btn-outline-secondary" type="submit">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="button-group">
                            <a href="{% url 'core:add_sample' %}" class="btn btn-success">
                                <i class="bi bi-plus-circle me-1"></i> Add Item
                            </a>
                            <a href="{% url 'core:import' %}" class="btn btn-primary ms-2">
                                <i class="bi bi-upload me-1"></i> Import
                            </a>
                            <button type="button" class="btn btn-success ms-2" id="make-available-btn" disabled>
                                <i class="bi bi-check-circle me-1"></i> Make Available
                            </button>
                            <button type="button" class="btn btn-primary ms-2" id="export-selected-btn" disabled>
                                <i class="bi bi-download me-1"></i> Export Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Options Row -->
    <div class="row mb-3">
       <div class="col-12">
           <div class="card shadow-sm">
               <div class="card-header filter-header">
                   <h5 class="card-title mb-0"><i class="bi bi-funnel me-2"></i>Filter Options</h5>
               </div>
               <div class="card-body py-3">
                   <form method="GET" action="{% url 'core:inventory' %}" id="filter-form">
                       {% if search_term %}
                       <input type="hidden" name="search" value="{{ search_term }}">
                       {% endif %}

                       <div class="row align-items-end">
                           <div class="col-md-2">
                               <label for="target" class="form-label small mb-1">Target</label>
                               <select class="form-select form-select-sm" name="target" id="target">
                                   <option value="">All Targets</option>
                                   {% for target in targets %}
                                       <option value="{{ target.id }}" {% if filters.target|stringformat:"s" == target.id|stringformat:"s" %}selected{% endif %}>{{ target.name }}</option>
                                   {% endfor %}
                               </select>
                           </div>

                           <div class="col-md-2">
                               <label for="sample_type" class="form-label small mb-1">Sample Type</label>
                               <select class="form-select form-select-sm" name="sample_type" id="sample_type">
                                   <option value="">All Sample Types</option>
                                   {% for type in sample_types %}
                                       <option value="{{ type.id }}" {% if filters.sample_type|stringformat:"s" == type.id|stringformat:"s" %}selected{% endif %}>{{ type.name }}</option>
                                   {% endfor %}
                               </select>
                           </div>

                           <div class="col-md-3">
                               <label class="form-label small mb-1">CT Value: <span id="ct-range-display">{{ filters.min_ct|default:"0" }} - {{ filters.max_ct|default:"50" }}</span></label>
                               <div id="ct-slider" class="mx-2"></div>
                               <input type="hidden" name="min_ct" id="min-ct" value="{{ filters.min_ct|default:"0" }}">
                               <input type="hidden" name="max_ct" id="max-ct" value="{{ filters.max_ct|default:"50" }}">
                           </div>

                           <div class="col-md-3">
                               <label class="form-label small mb-1">Volume (ml): <span id="volume-range-display">{{ filters.min_volume|default:"0" }} - {{ filters.max_volume|default:"1000" }}</span></label>
                               <div id="volume-slider" class="mx-2"></div>
                               <input type="hidden" name="min_volume" id="min-volume" value="{{ filters.min_volume|default:"0" }}">
                               <input type="hidden" name="max_volume" id="max-volume" value="{{ filters.max_volume|default:"1000" }}">
                           </div>

                           <div class="col-md-2">
                               <div class="d-flex gap-2">
                                   <button type="submit" class="btn btn-sm filter-apply-btn">
                                       <i class="bi bi-search me-1"></i> Apply
                                   </button>
                                   <a href="{% url 'core:inventory' %}" class="btn btn-sm btn-outline-secondary">
                                       <i class="bi bi-x-circle me-1"></i> Clear
                                   </a>
                               </div>
                           </div>
                       </div>

                       <div class="row mt-3">
                           <div class="col-12">
                               <button type="button" class="btn btn-outline-secondary" id="toggle-advanced-filters">
                                   <i class="bi bi-plus-circle me-1"></i> Advanced Filters
                               </button>
                           </div>
                       </div>

                       <div class="row mt-3" id="advanced-filters" style="display:none;">
                           <div class="col-md-6 d-flex">
                               <div class="me-2 flex-grow-1">
                                   <label for="positive_target" class="form-label small mb-1">Positive For</label>
                                   <select class="form-select form-select-sm" name="positive_target" id="positive_target">
                                       <option value="">All Targets</option>
                                       {% for target in targets %}
                                           <option value="{{ target.id }}" {% if filters.positive_target|stringformat:"s" == target.id|stringformat:"s" %}selected{% endif %}>{{ target.name }}</option>
                                       {% endfor %}
                                   </select>
                               </div>
                               <div class="flex-grow-1">
                                   <label for="negative_target" class="form-label small mb-1">Negative For</label>
                                   <select class="form-select form-select-sm" name="negative_target" id="negative_target">
                                       <option value="">All Targets</option>
                                       {% for target in targets %}
                                           <option value="{{ target.id }}" {% if filters.negative_target|stringformat:"s" == target.id|stringformat:"s" %}selected{% endif %}>{{ target.name }}</option>
                                       {% endfor %}
                                   </select>
                               </div>
                           </div>
                        </div>
                   </form>
               </div>
           </div>
       </div>
    </div>

    <!-- Table section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header" style="background-color: #304878; color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="bi bi-table me-2"></i>PCR Database</h5>
                        <div class="small">{{ samples|length }} results found</div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead style="background-color: #304878; color: white;">
                                <tr>
                                    <th width="40">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all">
                                        </div>
                                    </th>
                                    <th>Mikrogen Internal #</th>
                                    <th>Provider #</th>
                                    <th>Provider</th>
                                    {% if filters.positive_target or filters.negative_target %}
                                        <th>Positive For</th>
                                        <th>Negative For</th>
                                    {% else %}
                                        <th>Target</th>
                                        <th>Sample Type</th>
                                    {% endif %}
                                    <th>PCR Kit (Mikrogen)</th>
                                    <th>PCR Kit (External)</th>
                                    <th>CT Value (Mikrogen)</th>
                                    <th>CT Value (External)</th>
                                    <th>Volume</th>
                                    <th>Current User</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sample in samples %}
                                <tr class="{% if sample.active_use %}in-use-by-others{% elif sample.in_use and sample.current_user == request.user %}reserved-by-me{% elif sample.in_use and not sample.active_use %}reserved-by-others{% endif %}">
                                    <td>
                                        <div class="form-check">
                                            {% if sample.in_use and sample.current_user != request.user %}
                                                <!-- Disabled checkbox for samples in use or reserved by others -->
                                                <input class="form-check-input sample-checkbox" type="checkbox" value="{{ sample.id }}" disabled
                                                       title="{% if sample.active_use %}This sample is currently in use by {{ sample.current_user.username }}{% else %}This sample is reserved by {{ sample.current_user.username }}{% endif %}">
                                            {% else %}
                                                <!-- Regular checkbox for available samples or samples reserved by current user -->
                                                <input class="form-check-input sample-checkbox" type="checkbox" value="{{ sample.id }}">
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td><a href="{% url 'core:sample_detail' sample.mikrogen_internal_number %}" class="text-primary">{{ sample.mikrogen_internal_number }}</a></td>
                                    <td>{{ sample.provider_number }}</td>
                                    <td>{{ sample.provider.name }}</td>
                                    {% if filters.positive_target or filters.negative_target %}
                                        <td>{{ sample.positive_for|default:"-" }}</td>
                                        <td>{{ sample.negative_for|default:"-" }}</td>
                                    {% else %}
                                        <td>{{ sample.target.name }}</td>
                                        <td>{{ sample.sample_type.name }}</td>
                                    {% endif %}
                                    <td>{{ sample.mikrogen_pcr_kit.name|default:"-" }}</td>
                                    <td>{{ sample.external_pcr_kit.name|default:"-" }}</td>
                                    <td>{% if sample.mikrogen_ct_value %}{{ sample.mikrogen_ct_value|floatformat:1 }}{% else %}-{% endif %}</td>
                                    <td>{% if sample.external_ct_value %}{{ sample.external_ct_value|floatformat:1 }}{% else %}-{% endif %}</td>
                                    <td>
                                        {% if sample.sample_volume_remaining > 0 %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar
                                                    {% if sample.volume_percentage < 25 %}bg-danger{% elif sample.volume_percentage < 50 %}bg-warning{% else %}bg-success{% endif %}"
                                                    style="width: {{ sample.volume_percentage }}%"></div>
                                                </div>
                                                <span>{{ sample.sample_volume_remaining|floatformat:1 }} ml</span>
                                            </div>
                                        {% else %}
                                            <span class="text-danger">Empty</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if sample.not_found %}
                                            <span class="fw-bold text-warning">
                                                <i class="bi bi-question-circle me-1"></i>Not Found
                                            </span>
                                        {% elif sample.active_use %}
                                            <span class="fw-bold text-danger">
                                                <i class="bi bi-person me-1"></i> {{ sample.current_user.username }}
                                            </span>
                                        {% elif sample.in_use and not sample.active_use %}
                                            {% if sample.current_user == request.user %}
                                                <span class="fw-bold text-orange">
                                                    <i class="bi bi-clock me-1"></i>Reserved
                                                </span>
                                            {% else %}
                                                <span class="fw-bold text-orange">
                                                    <i class="bi bi-clock me-1"></i>Reserved by {{ sample.current_user.username }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="fw-bold text-success">
                                                <i class="bi bi-check-circle me-1"></i>Available
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="12" class="text-center py-5">
                                        <i class="bi bi-search fs-1 text-muted"></i>
                                        <p class="mt-3 text-muted">No samples found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this right before your modals -->
<form id="batch-actions-form" method="POST">
    {% csrf_token %}
    <div id="selected-samples-container"></div>
    <input type="hidden" name="volume_used" id="batch-volume-used">
</form>

<!-- Not Found Warning Modal -->
<div class="modal fade" id="notFoundWarningModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Cannot Export</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You have selected samples marked as "Not Found". These samples cannot be exported until they are marked as available.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for using samples -->
<div class="modal fade" id="useSamplesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-flask me-2"></i>Record Sample Usage</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    You've selected <span id="selected-count" class="fw-bold">0</span> samples that are currently in use.
                </div>
                <div class="mb-3">
                    <label for="volume-used" class="form-label">Volume Used (ml)</label>
                    <input type="number" class="form-control" id="volume-used" name="volume_used" step="0.1" min="0" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-use-btn">
                    <i class="bi bi-check-circle me-1"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

    <!--Modal for export confirmation -->
<div class="modal fade" id="exportConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-download me-2"></i>Export Samples</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    You're about to export <span id="export-count" class="fw-bold">0</span> samples.
                </div>
                <p>This will mark them as "Reserved".</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-export-btn">Export</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('select-all');
        const sampleCheckboxes = document.querySelectorAll('.sample-checkbox');
        const makeAvailableBtn = document.getElementById('make-available-btn');
        const exportSelectedBtn = document.getElementById('export-selected-btn');
        const batchActionsForm = document.getElementById('batch-actions-form');
        const selectedSamplesContainer = document.getElementById('selected-samples-container');
        const toggleAdvancedFiltersBtn = document.getElementById('toggle-advanced-filters');
        const advancedFilters = document.getElementById('advanced-filters');

        // Advanced filters toggle with persistence
        $("#toggle-advanced-filters").click(function() {
            $("#advanced-filters").slideToggle(300, function() {
                // Update button text based on visibility
                if ($("#advanced-filters").is(":visible")) {
                    $("#toggle-advanced-filters").html('<i class="bi bi-dash-circle me-1"></i> Hide Advanced Filters');
                    // Store state in session storage
                    sessionStorage.setItem('advancedFiltersOpen', 'true');
                } else {
                    $("#toggle-advanced-filters").html('<i class="bi bi-plus-circle me-1"></i> Advanced Filters');
                    // Clear stored state
                    sessionStorage.removeItem('advancedFiltersOpen');
                }
            });
        });

        // On page load, check session storage for advanced filters state
        $(document).ready(function() {
            const filtersOpen = sessionStorage.getItem('advancedFiltersOpen') === 'true';
            const hasAdvancedFilters = {{ filters.positive_target|yesno:"true,false" }} || {{ filters.negative_target|yesno:"true,false" }};

            if (filtersOpen || hasAdvancedFilters) {
                $("#advanced-filters").show();
                $("#toggle-advanced-filters").html('<i class="bi bi-dash-circle me-1"></i> Hide Advanced Filters');
            }

            // Remove stored state only when clear button is clicked
            $("a[href='{% url 'core:inventory' %}']").click(function() {
                sessionStorage.removeItem('advancedFiltersOpen');
            });
        });

        // Call this immediately to set initial state
        updateButtonState();

        // Select all functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                document.querySelectorAll('.sample-checkbox').forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                    // Add this code to highlight rows
                    const row = checkbox.closest('tr');
                    if (checkbox.checked) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
                updateButtonState();
            });
        }
        // Individual checkbox change
        document.querySelectorAll('.sample-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
              row.classList.add('selected');
            } else {
              row.classList.remove('selected');
            }
            updateButtonState();
          });
        });

        let lastChecked = null;

        sampleCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                if (!lastChecked) {
                    lastChecked = this;
                    return;
                }

                if (e.shiftKey) {
                    const start = Array.from(sampleCheckboxes).indexOf(this);
                    const end = Array.from(sampleCheckboxes).indexOf(lastChecked);

                    const checkboxesToUpdate = Array.from(sampleCheckboxes).slice(
                        Math.min(start, end),
                        Math.max(start, end) + 1
                    );

                    checkboxesToUpdate.forEach(cb => {
                        cb.checked = lastChecked.checked;
                    });
                }

                lastChecked = this;
                updateButtonState();
            });
        });

        // Update button disabled state
        function updateButtonState() {
            const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
            console.log("Checked count:", checkedCount);
            console.log("Make Available button:", makeAvailableBtn);
            console.log("Export Selected button:", exportSelectedBtn);

            if (makeAvailableBtn) makeAvailableBtn.disabled = checkedCount === 0;
            if (exportSelectedBtn) exportSelectedBtn.disabled = checkedCount === 0;
        }

        // Add hidden inputs for selected samples
        function addSelectedSampleInputs() {
            if (!selectedSamplesContainer) return;

            selectedSamplesContainer.innerHTML = '';
            document.querySelectorAll('.sample-checkbox:checked').forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'sample_ids';
                input.value = checkbox.value;
                selectedSamplesContainer.appendChild(input);
            });
        }

        // Export selected button
        if (exportSelectedBtn) {
            exportSelectedBtn.addEventListener('click', function(e) {
                e.preventDefault();

                // Check if any selected samples are marked as "not found"
                const notFoundSelected = Array.from(document.querySelectorAll('.sample-checkbox:checked')).some(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.querySelector('td:last-child span').textContent.trim().includes('Not Found');
                });

                if (notFoundSelected) {
                    // Show warning modal if not found samples are selected
                    const notFoundWarningModal = new bootstrap.Modal(document.getElementById('notFoundWarningModal'));
                    notFoundWarningModal.show();
                    return;
                }

                // Continue with normal export flow
                const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
                document.getElementById('export-count').textContent = checkedCount;
                const exportModal = new bootstrap.Modal(document.getElementById('exportConfirmModal'));
                exportModal.show();
            });
        }

        // Confirm export button
        const confirmExportBtn = document.getElementById('confirm-export-btn');
        if (confirmExportBtn) {
            confirmExportBtn.addEventListener('click', function() {
                addSelectedSampleInputs();
                batchActionsForm.action = "{% url 'core:export_samples' %}";

                // Set a flag to reload the page after form submission
                sessionStorage.setItem('shouldReload', 'true');

                batchActionsForm.submit();

                // If the form submits normally (not as a file download), reload
                setTimeout(function() {
                    if (sessionStorage.getItem('shouldReload') === 'true') {
                        window.location.reload();
                        sessionStorage.removeItem('shouldReload');
                    }
                }, 1000); // Wait a second to allow server processing
            });
        }

        // Make Available button
        if (makeAvailableBtn) {
            makeAvailableBtn.addEventListener('click', function(e) {
                e.preventDefault();

                const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
                if (checkedCount === 0) return;

                // Create a modal dynamically
                const modalHTML = `
                    <div class="modal fade" id="makeAvailableModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Make Available</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-success">
                                        <i class="bi bi-info-circle me-2"></i>
                                        You're about to mark <span class="fw-bold">${checkedCount}</span> samples as available.
                                    </div>
                                    <p>This will release these samples and make them available for all users.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" id="confirm-make-available-btn">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);

                // Initialize and show modal
                const modal = new bootstrap.Modal(document.getElementById('makeAvailableModal'));
                modal.show();

                // Set up confirm button
                document.getElementById('confirm-make-available-btn').addEventListener('click', function() {
                    addSelectedSampleInputs();
                    batchActionsForm.action = "{% url 'core:mark_samples_available' %}";
                    batchActionsForm.submit();
                });
            });
        }

        // Add row highlight on hover
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseover', function() {
                this.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            });
            row.addEventListener('mouseout', function() {
                this.style.backgroundColor = '';
            });
        });
    });
</script>

{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script>
$(document).ready(function() {
    // Initialize CT value slider
    $("#ct-slider").slider({
        range: true,
        min: 0,
        max: 50,
        values: [{{ filters.min_ct|default:"0" }}, {{ filters.max_ct|default:"50" }}],
        slide: function(event, ui) {
            $("#ct-range-display").text(ui.values[0] + " - " + ui.values[1]);
            $("#min-ct").val(ui.values[0]);
            $("#max-ct").val(ui.values[1]);
        }
    });

    // Initialize Volume slider
    $("#volume-slider").slider({
        range: true,
        min: 0,
        max: 1000,
        values: [{{ filters.min_volume|default:"0" }}, {{ filters.max_volume|default:"1000" }}],
        slide: function(event, ui) {
            $("#volume-range-display").text(ui.values[0] + " - " + ui.values[1]);
            $("#min-volume").val(ui.values[0]);
            $("#max-volume").val(ui.values[1]);
        }
    });

    // Ensure default values are set on page load
    $("#min-ct").val({{ filters.min_ct|default:"0" }});
    $("#max-ct").val({{ filters.max_ct|default:"50" }});
    $("#min-volume").val({{ filters.min_volume|default:"0" }});
    $("#max-volume").val({{ filters.max_volume|default:"1000" }});

    // Debug: Log values before form submission
    $("#filter-form").on("submit", function() {
        console.log("Target: " + $("#target").val());
        console.log("Sample Type: " + $("#sample_type").val());
        console.log("Min CT: " + $("#min-ct").val());
        console.log("Max CT: " + $("#max-ct").val());
        console.log("Min Volume: " + $("#min-volume").val());
        console.log("Max Volume: " + $("#max-volume").val());

        // Prevent submitting empty min/max values - if they're at defaults,
        // better to not include them in the query to avoid overfiltering
        if ($("#min-ct").val() == "0" && $("#max-ct").val() == "50") {
            $("#min-ct").removeAttr("name");
            $("#max-ct").removeAttr("name");
        }

        if ($("#min-volume").val() == "0" && $("#max-volume").val() == "1000") {
            $("#min-volume").removeAttr("name");
            $("#max-volume").removeAttr("name");
        }

        return true;
    });
});
</script>

{% endblock %}