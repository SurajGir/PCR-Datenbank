{% extends 'base.html' %}
{% load static %}

{% block title %}My Exported Samples - PCR Datenbank{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header" style="background-color: #304878; color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="bi bi-list-check me-2"></i>My Exported Samples</h5>
                        <div class="small">{{ count }} samples</div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead style="background-color: #304878; color: white;">
                                <tr>
                                    <th width="40">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all">
                                        </div>
                                    </th>
                                    <th>Mikrogen Internal #</th>
                                    <th>Provider #</th>
                                    <th>Target</th>
                                    <th>Sample Type</th>
                                    <th>Volume</th>
                                    <th>Export Date</th>
                                    <th>Current Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sample in samples %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input sample-checkbox" type="checkbox" value="{{ sample.id }}">
                                        </div>
                                    </td>
                                    <td><a href="{% url 'core:sample_detail' sample.mikrogen_internal_number %}" class="text-primary">{{ sample.mikrogen_internal_number }}</a></td>
                                    <td>{{ sample.provider_number }}</td>
                                    <td>{{ sample.target.name }}</td>
                                    <td>{{ sample.sample_type.name }}</td>
                                    <td>
                                        {% if sample.sample_volume_remaining > 0 %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar
                                                    {% if sample.volume_percentage < 25 %}bg-danger{% elif sample.volume_percentage < 50 %}bg-warning{% else %}bg-success{% endif %}"
                                                    style="width: {{ sample.volume_percentage }}%"></div>
                                                </div>
                                                <span>{{ sample.sample_volume_remaining|floatformat:1 }} ml</span>
                                            </div>
                                        {% else %}
                                            <span class="text-danger">Empty</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ sample.usage_logs.last.checkout_date|date:"Y-m-d H:i" }}</td>
                                    <!-- Status display for exported_list.html -->
                                    <td>
                                    {% if sample.not_found %}
                                        <span class="fw-bold text-warning">
                                            <i class="bi bi-question-circle me-1"></i>Not Found
                                        </span>
                                    {% elif sample.active_use %}
                                        <span class="fw-bold text-danger">
                                            <i class="bi bi-person me-1"></i>{{ sample.current_user.username }}
                                        </span>
                                    {% elif sample.in_use and sample.current_user == request.user %}
                                        <span class="fw-bold text-orange">
                                            <i class="bi bi-clock me-1"></i>Reserved
                                        </span>
                                    {% else %}
                                        <span class="fw-bold text-success">
                                            <i class="bi bi-check-circle me-1"></i>Available
                                        </span>
                                    {% endif %}
                                </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <i class="bi bi-inbox fs-1 text-muted"></i>
                                        <p class="mt-3 text-muted">You don't have any exported samples</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-center gap-3 mt-4">
        <button type="button" class="btn btn-primary" id="record-usage-btn" disabled>
            <i class="bi bi-check-circle me-1"></i> Record Usage
        </button>
        <button type="button" class="btn btn-warning" id="not-found-btn" disabled>
            <i class="bi bi-exclamation-triangle me-1"></i> Not Found
        </button>
        <button type="button" class="btn btn-success" id="deduct-volume-btn" disabled>
            <i class="bi bi-flask me-1"></i> Deduct Volume
        </button>
        <button type="button" class="btn btn-info" id="refresh-btn">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh Status
        </button>
    </div>

    <form id="action-form" method="POST">
        {% csrf_token %}
        <div id="selected-samples-container"></div>
        <input type="hidden" name="volume_used" id="batch-volume-used">
        <input type="hidden" name="action_type" id="action-type">
    </form>

    <!-- Usage Modal -->
    <div class="modal fade" id="usageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-flask me-2"></i>Record Sample Usage</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        You've selected <span id="selected-count" class="fw-bold">0</span> samples.
                    </div>
                    <div class="mb-3">
                        <label for="volume-used" class="form-label">Volume Used (ml)</label>
                        <input type="number" class="form-control" id="volume-used" step="0.1" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-use-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Usage Modal -->
    <div class="modal fade" id="recordUsageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>Record Usage</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        You're about to mark <span id="record-usage-count" class="fw-bold">0</span> samples as in use.
                    </div>
                    <p>This will change their status from "Reserved" to "In Use".</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-record-usage-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Status Modal -->
    <div class="modal fade" id="refreshStatusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-arrow-clockwise me-2"></i>Refresh Status</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        You're about to refresh the status of all samples.
                    </div>
                    <p>This will release any samples that are only "Reserved" (but not actively in use) from your list and make them available in the main inventory.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="confirm-refresh-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Not Found Modal -->
    <div class="modal fade" id="notFoundModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Mark as Not Found</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Mark <span id="not-found-count" class="fw-bold">0</span> samples as "Not Found"?</p>
                    <p>This will release these samples from your list and mark their status as 'Not found'.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-not-found-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - checking elements");

    const selectAllCheckbox = document.getElementById('select-all');
    const sampleCheckboxes = document.querySelectorAll('.sample-checkbox');
    const recordUsageBtn = document.getElementById('record-usage-btn');
    const notFoundBtn = document.getElementById('not-found-btn');
    const deductVolumeBtn = document.getElementById('deduct-volume-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const actionForm = document.getElementById('action-form');
    const selectedSamplesContainer = document.getElementById('selected-samples-container');
    const confirmUseBtn = document.getElementById('confirm-use-btn');

    // Log for debugging
    console.log("Elements found:", {
        selectAll: !!selectAllCheckbox,
        checkboxes: sampleCheckboxes.length,
        recordBtn: !!recordUsageBtn,
        notFoundBtn: !!notFoundBtn,
        deductBtn: !!deductVolumeBtn,
        refreshBtn: !!refreshBtn,
        actionForm: !!actionForm
    });

    // Initialize modals
    const usageModal = new bootstrap.Modal(document.getElementById('usageModal'));
    const notFoundModal = new bootstrap.Modal(document.getElementById('notFoundModal'));

    // Select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            sampleCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateButtonState();
        });
    }

    // Individual checkbox change
        document.querySelectorAll('.sample-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateButtonState);
        });

        let lastChecked = null;

        sampleCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                if (!lastChecked) {
                    lastChecked = this;
                    return;
                }

                if (e.shiftKey) {
                    const start = Array.from(sampleCheckboxes).indexOf(this);
                    const end = Array.from(sampleCheckboxes).indexOf(lastChecked);

                    const checkboxesToUpdate = Array.from(sampleCheckboxes).slice(
                        Math.min(start, end),
                        Math.max(start, end) + 1
                    );

                    checkboxesToUpdate.forEach(cb => {
                        cb.checked = lastChecked.checked;
                    });
                }

                lastChecked = this;
                updateButtonState();
            });
        });

    // Update button disabled state
    function updateButtonState() {
        const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
        console.log("Checked count:", checkedCount);

        // Set disabled state
        if (recordUsageBtn) recordUsageBtn.disabled = checkedCount === 0;
        if (notFoundBtn) notFoundBtn.disabled = checkedCount === 0;
        if (deductVolumeBtn) deductVolumeBtn.disabled = checkedCount === 0;
    }

    // Add hidden inputs for selected samples
    function addSelectedSampleInputs() {
        if (!selectedSamplesContainer) return;

        selectedSamplesContainer.innerHTML = '';
        document.querySelectorAll('.sample-checkbox:checked').forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'sample_ids';
            input.value = checkbox.value;
            selectedSamplesContainer.appendChild(input);
        });
    }

    // Record Usage button - show modal
    if (recordUsageBtn) {
        recordUsageBtn.addEventListener('click', function() {
            const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
            if (checkedCount === 0) return;

            document.getElementById('record-usage-count').textContent = checkedCount;
            const recordUsageModal = new bootstrap.Modal(document.getElementById('recordUsageModal'));
            recordUsageModal.show();
        });
    }

    // Confirm record usage button
    const confirmRecordUsageBtn = document.getElementById('confirm-record-usage-btn');
    if (confirmRecordUsageBtn) {
        confirmRecordUsageBtn.addEventListener('click', function() {
            addSelectedSampleInputs();
            actionForm.action = "{% url 'core:record_active_use' %}";
            actionForm.submit();
        });
    }

   // Not found button - show modal
    if (notFoundBtn) {
        notFoundBtn.addEventListener('click', function() {
            const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
            if (checkedCount === 0) return;

            document.getElementById('not-found-count').textContent = checkedCount;
            notFoundModal.show();
        });
    }

    // Confirm not found button in modal
    const confirmNotFoundBtn = document.getElementById('confirm-not-found-btn');
    if (confirmNotFoundBtn) {
        confirmNotFoundBtn.addEventListener('click', function() {
            console.log("Not Found confirmation clicked");
            addSelectedSampleInputs();
            actionForm.action = "{% url 'core:mark_samples_not_found' %}";
            actionForm.submit();
            notFoundModal.hide(); // Explicitly hide the modal
        });
    }

    // Deduct Volume button
    if (deductVolumeBtn) {
        deductVolumeBtn.addEventListener('click', function() {
            const checkedCount = document.querySelectorAll('.sample-checkbox:checked').length;
            document.getElementById('selected-count').textContent = checkedCount;
            document.getElementById('volume-used').value = '';
            usageModal.show();
        });
    }

    // Confirm deduct volume button
    if (confirmUseBtn) {
        confirmUseBtn.addEventListener('click', function() {
            addSelectedSampleInputs();
            document.getElementById('batch-volume-used').value = document.getElementById('volume-used').value;
            actionForm.action = "{% url 'core:mark_samples_finished' %}";
            actionForm.submit();
        });
    }

    // Refresh button - show modal
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            const refreshStatusModal = new bootstrap.Modal(document.getElementById('refreshStatusModal'));
            refreshStatusModal.show();
        });
    }

    // Confirm refresh button
    const confirmRefreshBtn = document.getElementById('confirm-refresh-btn');
    if (confirmRefreshBtn) {
        confirmRefreshBtn.addEventListener('click', function() {
            document.getElementById('action-type').value = 'refresh';
            actionForm.action = "{% url 'core:refresh_samples' %}";
            actionForm.submit();
        });
    }
});
</script>
{% endblock %}